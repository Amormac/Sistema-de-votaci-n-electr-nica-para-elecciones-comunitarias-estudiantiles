{% extends 'base.html' %}

{% block content %}
<a href="{{ url_for('admin.elecciones') }}" class="back-link">&larr; Volver a Elecciones</a>

<div class="page-header">
    <div>
        <h1>{{ eleccion.titulo }}</h1>
        <p class="text-muted mb-0">
            {% if eleccion.cerrada %}
            <span class="badge badge-danger">CERRADA</span>
            {% elif eleccion.activa %}
            <span class="badge badge-success">ACTIVA</span>
            {% else %}
            <span class="badge badge-neutral">CONFIGURANDO</span>
            {% endif %}
        </p>
    </div>
    {% if es_editable %}
    <form method="post" onsubmit="return confirm('¬øActivar esta elecci√≥n? Los votantes podr√°n votar inmediatamente.');">
        <input type="hidden" name="action" value="activate">
        <button class="btn btn-success">üöÄ Activar Elecci√≥n</button>
    </form>
    {% endif %}
</div>

{# ========== SECCI√ìN 1: DATOS GENERALES ========== #}
<div class="card">
    <h3>üìã Datos Generales</h3>
    {% if es_editable %}
    <form method="post">
        <input type="hidden" name="action" value="update_info">
        <label>T√≠tulo</label>
        <input type="text" name="titulo" value="{{ eleccion.titulo }}" required>

        <div class="form-row">
            <div>
                <label>Fecha Inicio</label>
                <input type="datetime-local" name="fecha_inicio"
                    value="{{ eleccion.fecha_inicio.strftime('%Y-%m-%dT%H:%M') if eleccion.fecha_inicio else '' }}"
                    required>
            </div>
            <div>
                <label>Fecha Fin</label>
                <input type="datetime-local" name="fecha_fin"
                    value="{{ eleccion.fecha_fin.strftime('%Y-%m-%dT%H:%M') if eleccion.fecha_fin else '' }}" required>
            </div>
        </div>

        <div class="form-check">
            <input type="checkbox" name="tiene_segunda_vuelta" id="segunda_vuelta" {% if eleccion.tiene_segunda_vuelta
                %}checked{% endif %}>
            <label for="segunda_vuelta">Permitir Segunda Vuelta</label>
        </div>

        <button type="submit" class="btn btn-primary btn-sm">Guardar Cambios</button>
    </form>
    {% else %}
    <div class="grid-2">
        <div>
            <p><strong>Inicio:</strong> {{ eleccion.fecha_inicio }}</p>
            <p><strong>Fin:</strong> {{ eleccion.fecha_fin }}</p>
        </div>
        <div>
            <p><strong>Segunda vuelta:</strong> {{ "S√≠" if eleccion.tiene_segunda_vuelta else "No" }}</p>
            <p><strong>Vuelta actual:</strong> {{ eleccion.vuelta_actual }}</p>
        </div>
    </div>
    {% endif %}
</div>

{# ========== SECCI√ìN 2: CARGOS A ELEGIR ========== #}
<div class="card">
    <h3>üè∑Ô∏è Cargos a Elegir</h3>

    {% if es_editable %}
    <p class="text-muted">Agrega los cargos que se votar√°n en esta elecci√≥n.</p>

    <form method="post" class="mb-3" style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
        <input type="hidden" name="action" value="add_cargo_nuevo">
        <div style="flex: 1; min-width: 200px;">
            <label>Nombre del Cargo</label>
            <input type="text" name="cargo_nombre" placeholder="Ej: Presidente, Vicepresidente..." required
                style="margin-bottom: 0;">
        </div>
        <div style="flex: 1; min-width: 200px;">
            <label>Descripci√≥n (opcional)</label>
            <input type="text" name="cargo_descripcion" placeholder="Breve descripci√≥n" style="margin-bottom: 0;">
        </div>
        <button type="submit" class="btn btn-success btn-sm" style="height: fit-content;">+ Agregar Cargo</button>
    </form>

    {% if todos_cargos %}
    <details class="mb-2">
        <summary class="text-muted" style="cursor:pointer; font-size:0.85rem;">O seleccionar de cargos existentes...
        </summary>
        <form method="post" class="mt-2">
            <input type="hidden" name="action" value="save_cargos">
            <div style="display:flex; flex-wrap:wrap; gap:0.75rem;">
                {% for c in todos_cargos %}
                <div class="form-check">
                    <input type="checkbox" name="cargos" value="{{ c.id }}" id="cargo_{{ c.id }}" {% if c.id in
                        asignados_ids %}checked{% endif %}>
                    <label for="cargo_{{ c.id }}">{{ c.nombre }}</label>
                </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">Guardar Selecci√≥n</button>
        </form>
    </details>
    {% endif %}
    {% endif %}

    {% if cargos_asignados %}
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Cargo</th>
                    <th>Candidatos</th>
                    {% if es_editable %}<th>Acciones</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for cargo in cargos_asignados %}
                <tr>
                    <td><strong>{{ cargo.nombre }}</strong><br><small class="text-muted">{{ cargo.descripcion or ''
                            }}</small></td>
                    <td>
                        <span
                            class="badge {% if (candidatos_por_cargo.get(cargo.id, []) | length) >= 2 %}badge-success{% else %}badge-warning{% endif %}">
                            {{ candidatos_por_cargo.get(cargo.id, []) | length }} candidato{{ 's' if
                            (candidatos_por_cargo.get(cargo.id, []) | length) != 1 else '' }}
                        </span>
                    </td>
                    {% if es_editable %}
                    <td>
                        <form method="post" class="inline-form"
                            onsubmit="return confirm('¬øRemover este cargo y TODOS sus candidatos?');">
                            <input type="hidden" name="action" value="remove_cargo">
                            <input type="hidden" name="cargo_id" value="{{ cargo.id }}">
                            <button class="btn btn-sm btn-danger btn-icon" title="Remover">‚úï</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted text-center">No hay cargos asignados a√∫n. Agrega al menos uno para continuar.</p>
    {% endif %}
</div>

{# ========== SECCI√ìN 3: CANDIDATOS POR CARGO ========== #}
{% if cargos_asignados %}
<div class="card" id="candidatos">
    <h3>üë• Candidatos</h3>
    <p class="text-muted">{{ "Agrega al menos 2 candidatos por cargo." if es_editable else "Candidatos registrados para
        esta elecci√≥n." }}</p>

    {% for cargo in cargos_asignados %}
    <div class="card" style="border-left: 3px solid var(--primary); background: #fafbfc;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
            <h3 class="mb-0" style="font-size: 1rem;">{{ cargo.nombre }}</h3>
            <span
                class="badge {% if (candidatos_por_cargo.get(cargo.id, []) | length) >= 2 %}badge-success{% else %}badge-warning{% endif %}">
                {{ candidatos_por_cargo.get(cargo.id, []) | length }} / 2+ requeridos
            </span>
        </div>

        {% set cands = candidatos_por_cargo.get(cargo.id, []) %}
        {% if cands %}
        <div class="table-responsive mt-2">
            <table>
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>Nombre</th>
                        <th>Partido</th>
                        <th>G√©nero</th>
                        {% if es_editable %}<th>Acciones</th>{% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for cand in cands %}
                    <tr id="cand-row-{{ cand.id }}">
                        <td>
                            {% if cand.foto_url %}
                            <img src="{{ url_for('static', filename='uploads/candidatos/' + cand.foto_url) }}"
                                alt="{{ cand.nombres }}"
                                style="width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid var(--border-color);">
                            {% else %}
                            <img src="{{ url_for('static', filename='img/avatar_female.png') if cand.genero == 'F' else url_for('static', filename='img/avatar_male.png') }}"
                                alt="{{ cand.nombres }}"
                                style="width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid var(--border-color);">
                            {% endif %}
                        </td>
                        <td><strong>{{ cand.nombres }}</strong></td>
                        <td>{{ cand.partido }}</td>
                        <td><span class="badge badge-neutral">{{ "Femenino" if cand.genero == 'F' else "Masculino"
                                }}</span></td>
                        {% if es_editable %}
                        <td>
                            <div style="display: flex; gap: 0.3rem;">
                                <button type="button" class="btn btn-sm btn-primary btn-icon" title="Editar"
                                    onclick="toggleEdit({{ cand.id }})">‚úèÔ∏è</button>
                                <form method="post" class="inline-form"
                                    onsubmit="return confirm('¬øEliminar este candidato?');">
                                    <input type="hidden" name="action" value="delete_candidato">
                                    <input type="hidden" name="candidato_id" value="{{ cand.id }}">
                                    <button class="btn btn-sm btn-danger btn-icon" title="Eliminar">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% if es_editable %}
                    <tr id="cand-edit-{{ cand.id }}" style="display: none; background: #f0f4ff;">
                        <td colspan="5">
                            <form method="post" enctype="multipart/form-data"
                                style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap; padding: 0.5rem 0;">
                                <input type="hidden" name="action" value="edit_candidato">
                                <input type="hidden" name="candidato_id" value="{{ cand.id }}">
                                <div style="flex: 1; min-width: 150px;">
                                    <label>Nombre</label>
                                    <input type="text" name="nombres" value="{{ cand.nombres }}" required
                                        style="margin-bottom:0;">
                                </div>
                                <div style="flex: 1; min-width: 130px;">
                                    <label>Partido</label>
                                    <input type="text" name="partido" value="{{ cand.partido }}"
                                        style="margin-bottom:0;">
                                </div>
                                <div style="min-width: 100px;">
                                    <label>G√©nero</label>
                                    <select name="genero" style="margin-bottom:0;">
                                        <option value="M" {% if cand.genero=='M' %}selected{% endif %}>Masculino
                                        </option>
                                        <option value="F" {% if cand.genero=='F' %}selected{% endif %}>Femenino</option>
                                    </select>
                                </div>
                                <div style="min-width: 120px;">
                                    <label>üì∑ Nueva foto</label>
                                    <input type="file" name="foto" accept="image/*"
                                        style="margin-bottom:0; font-size:0.75rem;">
                                </div>
                                <button type="submit" class="btn btn-success btn-sm" style="height:fit-content;">üíæ
                                    Guardar</button>
                                <button type="button" class="btn btn-sm" style="height:fit-content;"
                                    onclick="toggleEdit({{ cand.id }})">‚úï</button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {# Form para agregar candidato #}
        {% if es_editable %}
        <form method="post" enctype="multipart/form-data" class="mt-2"
            style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
            <input type="hidden" name="action" value="add_candidato">
            <input type="hidden" name="cargo_id" value="{{ cargo.id }}">
            <div style="flex: 1; min-width: 150px;">
                <label>Nombre completo</label>
                <input type="text" name="nombres" placeholder="Nombre del candidato" required style="margin-bottom:0;">
            </div>
            <div style="flex: 1; min-width: 130px;">
                <label>Partido / Lista</label>
                <input type="text" name="partido" placeholder="Nombre del partido" style="margin-bottom:0;">
            </div>
            <div style="min-width: 100px;">
                <label>G√©nero</label>
                <select name="genero" style="margin-bottom:0;">
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                </select>
            </div>
            <div style="min-width: 120px;">
                <label>üì∑ Foto</label>
                <input type="file" name="foto" accept="image/*" style="margin-bottom:0; font-size: 0.75rem;">
            </div>
            <button type="submit" class="btn btn-success btn-sm" style="height: fit-content;">+ Candidato</button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

{# ========== SECCI√ìN 4: VOTANTES HABILITADOS ========== #}
{% if es_editable %}
<div class="card" id="votantes">
    <h3>üó≥Ô∏è Votantes Habilitados</h3>
    <p class="text-muted">Configura qui√©nes pueden votar en esta elecci√≥n.</p>

    <form method="post" class="mb-3">
        <input type="hidden" name="action" value="toggle_todos_habilitados">
        <div class="form-check">
            <input type="checkbox" name="todos_habilitados" id="todos_hab" {% if eleccion.todos_habilitados %}checked{%
                endif %} onchange="this.form.submit();">
            <label for="todos_hab"><strong>Todos los votantes habilitados pueden votar</strong></label>
        </div>
    </form>

    {% if not eleccion.todos_habilitados %}
    <form method="post">
        <input type="hidden" name="action" value="save_votantes">
        <div
            style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.75rem;">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <button type="button" class="btn btn-sm" onclick="toggleAllVotantes(true)">Seleccionar todos</button>
                <button type="button" class="btn btn-sm" onclick="toggleAllVotantes(false)">Deseleccionar todos</button>
                <input type="text" id="buscar-votante" placeholder="üîç Buscar por nombre o c√©dula..."
                    style="margin-bottom:0; flex:1; font-size:0.85rem;" oninput="filtrarVotantes()">
            </div>
            {% for v in todos_votantes %}
            <div class="form-check votante-item" data-search="{{ v.cedula }} {{ v.nombres }} {{ v.apellidos }}">
                <input type="checkbox" name="votante_ids" value="{{ v.id }}" id="vot_{{ v.id }}" {% if v.id in
                    votantes_asignados_ids %}checked{% endif %}>
                <label for="vot_{{ v.id }}">{{ v.cedula }} ‚Äî {{ v.nombres }} {{ v.apellidos }}</label>
            </div>
            {% endfor %}
        </div>
        <div class="mt-2" style="display: flex; justify-content: space-between; align-items: center;">
            <span class="text-muted" id="votantes-count">{{ votantes_asignados_ids | length }} seleccionados</span>
            <button type="submit" class="btn btn-primary btn-sm">üíæ Guardar Votantes</button>
        </div>
    </form>
    {% endif %}
</div>
{% endif %}

<script>
    function toggleEdit(id) {
        const row = document.getElementById('cand-edit-' + id);
        row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
    }

    function toggleAllVotantes(checked) {
        document.querySelectorAll('input[name="votante_ids"]').forEach(cb => {
            if (cb.closest('.votante-item').style.display !== 'none') {
                cb.checked = checked;
            }
        });
        updateVotantesCount();
    }

    function filtrarVotantes() {
        const q = document.getElementById('buscar-votante').value.toLowerCase();
        document.querySelectorAll('.votante-item').forEach(item => {
            const text = item.dataset.search.toLowerCase();
            item.style.display = text.includes(q) ? '' : 'none';
        });
    }

    function updateVotantesCount() {
        const count = document.querySelectorAll('input[name="votante_ids"]:checked').length;
        const el = document.getElementById('votantes-count');
        if (el) el.textContent = count + ' seleccionados';
    }
    document.querySelectorAll('input[name="votante_ids"]').forEach(cb => cb.addEventListener('change', updateVotantesCount));
</script>

{% endblock %}